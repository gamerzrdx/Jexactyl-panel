#!/bin/bash
# =========================================
# Jexactyl + Wings Installer | Powered by RDX
# =========================================
set -e

# --------- COLORS ---------
GREEN="\033[0;32m"
RED="\033[0;31m"
YELLOW="\033[1;33m"
CYAN="\033[0;36m"
NC="\033[0m"

# --------- FUNCTIONS ---------
install_panel() {
    echo -e "${CYAN}🚀 Installing Jexactyl Panel...${NC}"

    # Ask for admin info
    read -p "Enter admin email: " ADMIN_EMAIL
    read -p "Enter admin username: " ADMIN_USER
    read -s -p "Enter admin password: " ADMIN_PASSWORD
    echo
    read -p "Enter your domain (example.com) [localhost]: " DOMAIN
    DOMAIN=${DOMAIN:-localhost}

    DB_NAME="jexactyl"
    DB_USER="jexactyluser"
    DB_PASS=$(openssl rand -base64 12)

    echo -e "${YELLOW}📦 Updating system and installing dependencies...${NC}"
    apt update && apt upgrade -y
    apt install -y software-properties-common curl unzip git mariadb-server mariadb-client nginx php-cli php-fpm php-mysql php-gd php-curl php-mbstring php-xml php-bcmath php-tokenizer php-zip redis-server nodejs npm yarn composer unzip git certbot python3-certbot-nginx

    echo -e "${YELLOW}🛠 Setting up MariaDB...${NC}"
    mysql -e "CREATE DATABASE ${DB_NAME}; CREATE USER '${DB_USER}'@'localhost' IDENTIFIED BY '${DB_PASS}'; GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '${DB_USER}'@'localhost'; FLUSH PRIVILEGES;"

    echo -e "${YELLOW}📥 Downloading Jexactyl Panel...${NC}"
    cd /var/www/
    git clone https://github.com/jexactyl/jexactyl.git jexactyl
    cd jexactyl
    composer install --no-dev --optimize-autoloader

    echo -e "${YELLOW}🔑 Setting permissions...${NC}"
    chown -R www-data:www-data /var/www/jexactyl
    chmod -R 755 /var/www/jexactyl

    echo -e "${YELLOW}📄 Setting up environment...${NC}"
    cp .env.example .env
    sed -i "s/DB_DATABASE=.*/DB_DATABASE=${DB_NAME}/" .env
    sed -i "s/DB_USERNAME=.*/DB_USERNAME=${DB_USER}/" .env
    sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=${DB_PASS}/" .env

    php artisan key:generate
    php artisan migrate --seed

    echo -e "${YELLOW}📦 Installing Node dependencies...${NC}"
    npm install
    npm run build:production

    echo -e "${YELLOW}🌐 Configuring Nginx...${NC}"
    cat > /etc/nginx/sites-available/jexactyl <<EOL
server {
    listen 80;
    server_name ${DOMAIN};

    root /var/www/jexactyl/public;
    index index.php;

    location / {
        try_files \$uri /index.php\$is_args\$args;
    }

    location ~ \.php\$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.1-fpm.sock;
    }

    location ~ /\.ht {
        deny all;
    }
}
EOL

    ln -s /etc/nginx/sites-available/jexactyl /etc/nginx/sites-enabled/
    nginx -t
    systemctl restart nginx

    if [ "$DOMAIN" != "localhost" ]; then
        echo -e "${YELLOW}🔒 Installing SSL via Certbot...${NC}"
        certbot --nginx -d ${DOMAIN} --non-interactive --agree-tos -m ${ADMIN_EMAIL}
    fi

    php artisan user:create --email=${ADMIN_EMAIL} --username=${ADMIN_USER} --password=${ADMIN_PASSWORD} --admin
    echo -e "${GREEN}✅ Jexactyl Panel installation complete!${NC}"
}

install_wings() {
    echo -e "${CYAN}🚀 Installing Wings Node...${NC}"

    apt update && apt install -y curl sudo git unzip
    curl -sSL https://get.docker.com | CHANNEL=stable sh
    systemctl enable docker

    curl -L https://github.com/jexactyl/wings/releases/latest/download/wings_linux_amd64 -o /usr/local/bin/wings
    chmod +x /usr/local/bin/wings

    cat > /etc/systemd/system/wings.service <<EOL
[Unit]
Description=Wings Daemon
After=network.target docker.service

[Service]
User=root
WorkingDirectory=/etc/wings
ExecStart=/usr/local/bin/wings
Restart=on-failure
StartLimitInterval=600
StartLimitBurst=3

[Install]
WantedBy=multi-user.target
EOL

    mkdir -p /etc/wings
    systemctl enable --now wings
    echo -e "${GREEN}✅ Wings Node installation complete!${NC}"
}

update_panel() {
    echo -e "${CYAN}🔄 Updating Jexactyl Panel...${NC}"
    cd /var/www/jexactyl
    git pull
    composer install --no-dev --optimize-autoloader
    php artisan migrate --force
    npm install
    npm run build:production
    echo -e "${GREEN}✅ Panel updated!${NC}"
}

update_wings() {
    echo -e "${CYAN}🔄 Updating Wings...${NC}"
    systemctl stop wings
    curl -L https://github.com/jexactyl/wings/releases/latest/download/wings_linux_amd64 -o /usr/local/bin/wings
    chmod +x /usr/local/bin/wings
    systemctl start wings
    echo -e "${GREEN}✅ Wings updated!${NC}"
}

reinstall_all() {
    echo -e "${RED}🔄 Reinstalling everything...${NC}"
    install_panel
    install_wings
}

# --------- MENU ---------
while true; do
    echo -e "\n${YELLOW}===== Jexactyl Installer Menu | Powered by RDX =====${NC}"
    echo "0) Exit"
    echo "1) Install Jexactyl Panel"
    echo "2) Install Wings Node"
    echo "3) Install Both Panel + Wings"
    echo "4) Update Panel"
    echo "5) Update Wings"
    echo "6) Reinstall Everything"
    read -p "Choose an option [0-6]: " OPTION

    case $OPTION in
        0) echo -e "${RED}Exiting...${NC}"; exit 0 ;;
        1) install_panel ;;
        2) install_wings ;;
        3) install_panel; install_wings ;;
        4) update_panel ;;
        5) update_wings ;;
        6) reinstall_all ;;
        *) echo -e "${RED}Invalid option!${NC}" ;;
    esac
done
