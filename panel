#!/bin/bash
# =========================================
# Unofficial Pteradrycl Installer | Powered by RDX
# Works on localhost or domain
# =========================================
set -e

# --------- COLORS ---------
GREEN="\033[0;32m"
RED="\033[0;31m"
YELLOW="\033[1;33m"
CYAN="\033[0;36m"
NC="\033[0m"

# --------- ASCII Banner ---------
cat << "EOF"
                                                             
                                                             
RRRRRRRRRRRRRRRRR   DDDDDDDDDDDDD       XXXXXXX       XXXXXXX
R::::::::::::::::R  D::::::::::::DDD    X:::::X       X:::::X
R::::::RRRRRR:::::R D:::::::::::::::DD  X:::::X       X:::::X
RR:::::R     R:::::RDDD:::::DDDDD:::::D X::::::X     X::::::X
  R::::R     R:::::R  D:::::D    D:::::DXXX:::::X   X:::::XXX
  R::::R     R:::::R  D:::::D     D:::::D  X:::::X X:::::X   
  R::::RRRRRR:::::R   D:::::D     D:::::D   X:::::X:::::X    
  R:::::::::::::RR    D:::::D     D:::::D    X:::::::::X     
  R::::RRRRRR:::::R   D:::::D     D:::::D    X:::::::::X     
  R::::R     R:::::R  D:::::D     D:::::D   X:::::X:::::X    
  R::::R     R:::::R  D:::::D     D:::::D  X:::::X X:::::X   
  R::::R     R:::::R  D:::::D    D:::::DXXX:::::X   X:::::XXX
RR:::::R     R:::::RDDD:::::DDDDD:::::D X::::::X     X::::::X
R::::::R     R:::::RD:::::::::::::::DD  X:::::X       X:::::X
R::::::R     R:::::RD::::::::::::DDD    X:::::X       X:::::X
RRRRRRRR     RRRRRRRDDDDDDDDDDDDD       XXXXXXX       XXXXXXX
                                                             
                                                             
EOF

echo -e "${YELLOW}Welcome to the Unofficial Pteradrycl Installer!${NC}"

# --------- FUNCTIONS ---------
ask_yes_no() {
    while true; do
        read -p "$1 [y/n]: " yn
        case $yn in
            [Yy]*) return 0 ;;
            [Nn]*) return 1 ;;
            *) echo "Please answer y or n." ;;
        esac
    done
}

install_panel() {
    echo -e "${CYAN}ðŸš€ Installing Panel...${NC}"

    read -p "Enter admin email [admin@localhost]: " ADMIN_EMAIL
    ADMIN_EMAIL=${ADMIN_EMAIL:-admin@localhost}

    read -p "Enter admin username [admin]: " ADMIN_USER
    ADMIN_USER=${ADMIN_USER:-admin}

    read -s -p "Enter admin password [root99]: " ADMIN_PASSWORD
    ADMIN_PASSWORD=${ADMIN_PASSWORD:-root99}
    echo

    read -p "Enter domain (leave blank for localhost): " DOMAIN
    DOMAIN=${DOMAIN:-localhost}

    DB_NAME="paneldb"
    DB_USER="paneluser"
    DB_PASS=$(openssl rand -base64 12)

    echo -e "${YELLOW}ðŸ“¦ Updating system & installing dependencies...${NC}"
    apt update && apt upgrade -y
    apt install -y software-properties-common curl unzip git mariadb-server mariadb-client nginx php-cli php-fpm php-mysql php-gd php-curl php-mbstring php-xml php-bcmath php-tokenizer php-zip redis-server nodejs npm yarn composer unzip git certbot python3-certbot-nginx

    echo -e "${YELLOW}ðŸ›  Setting up MariaDB...${NC}"
    mysql -e "CREATE DATABASE ${DB_NAME}; CREATE USER '${DB_USER}'@'localhost' IDENTIFIED BY '${DB_PASS}'; GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '${DB_USER}'@'localhost'; FLUSH PRIVILEGES;"

    echo -e "${YELLOW}ðŸ“¥ Downloading Panel...${NC}"
    cd /var/www/
    git clone https://github.com/jexactyl/jexactyl.git panel
    cd panel
    composer install --no-dev --optimize-autoloader

    chown -R www-data:www-data /var/www/panel
    chmod -R 755 /var/www/panel

    cp .env.example .env
    sed -i "s/DB_DATABASE=.*/DB_DATABASE=${DB_NAME}/" .env
    sed -i "s/DB_USERNAME=.*/DB_USERNAME=${DB_USER}/" .env
    sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=${DB_PASS}/" .env

    php artisan key:generate
    php artisan migrate --seed

    npm install
    npm run build:production

    # Nginx configuration
    cat > /etc/nginx/sites-available/panel <<EOL
server {
    listen 80;
    server_name ${DOMAIN};

    root /var/www/panel/public;
    index index.php;

    location / {
        try_files \$uri /index.php\$is_args\$args;
    }

    location ~ \.php\$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.1-fpm.sock;
    }

    location ~ /\.ht {
        deny all;
    }
}
EOL

    ln -s /etc/nginx/sites-available/panel /etc/nginx/sites-enabled/
    nginx -t
    systemctl restart nginx

    if ask_yes_no "Install SSL? (skip if using localhost)"; then
        if [ "$DOMAIN" != "localhost" ]; then
            certbot --nginx -d ${DOMAIN} --non-interactive --agree-tos -m ${ADMIN_EMAIL}
        fi
    fi

    php artisan user:create --email=${ADMIN_EMAIL} --username=${ADMIN_USER} --password=${ADMIN_PASSWORD} --admin
    echo -e "${GREEN}âœ… Panel installed!${NC}"
}

install_wings() {
    echo -e "${CYAN}ðŸš€ Installing Wings Node...${NC}"

    apt update && apt install -y curl sudo git unzip
    curl -sSL https://get.docker.com | CHANNEL=stable sh
    systemctl enable docker

    curl -L https://github.com/jexactyl/wings/releases/latest/download/wings_linux_amd64 -o /usr/local/bin/wings
    chmod +x /usr/local/bin/wings

    cat > /etc/systemd/system/wings.service <<EOL
[Unit]
Description=Wings Daemon
After=network.target docker.service

[Service]
User=root
WorkingDirectory=/etc/wings
ExecStart=/usr/local/bin/wings
Restart=on-failure
StartLimitInterval=600
StartLimitBurst=3

[Install]
WantedBy=multi-user.target
EOL

    mkdir -p /etc/wings
    systemctl enable --now wings
    echo -e "${GREEN}âœ… Wings Node installed!${NC}"
}

# --------- START INSTALL ---------
echo -e "${YELLOW}===== Unofficial Pteradrycl Installer | Powered by RDX =====${NC}"

if ask_yes_no "Install Panel?"; then
    install_panel
fi

if ask_yes_no "Install Wings Node?"; then
    install_wings
fi

echo -e "${CYAN}ðŸŽ‰ Installation complete!${NC}"
echo -e "${CYAN}Panel URL: http://${DOMAIN}${NC}"
echo -e "${CYAN}Admin Username: ${ADMIN_USER}${NC}"
echo -e "${CYAN}Admin Email: ${ADMIN_EMAIL}${NC}"
echo -e "${CYAN}Admin Password: ${ADMIN_PASSWORD}${NC}"
echo -e "${YELLOW}Powered by RDX${NC}"
